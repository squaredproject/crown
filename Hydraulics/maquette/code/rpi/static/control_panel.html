<!doctype html>
  
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Crown Control</title>
  <meta name="description" content="Control Panel for Crown Sculpture">

  <link rel="stylesheet" type="text/css" href="style/jquery-ui-min-1.8.24.css">
  <link rel="stylesheet" type="text/css" href="style/maquette.css">

</head>
<body>
<div id="tabs">
   <ul>
       <li><a href="#maquette_div">Maquette</a></li>
       <li><a href="#sculpture_div">Sculpture</a></li>
   </ul>
    <div id="maquette_div">
    <h3> Maquette </h3>
    <div id="maquette_control">
      <div id="maquette_mode" class="pane">
      <span class="subhead1">Maquette Mode:<br></span>
      <select id="maquetteMode">
        <option value="OFF" selected="selected">OFF</option>
        <option value="POSE">Pose</option>
        <option value="IMMEDIATE" disabled>Mimic</option>
      </select>
      </div> <!-- maquette mode-->
      <div id="towerControl" class="pane"> 
      <span class="subhead1"> Maquette Tower Control:<br> </span>
      <div class="calibration_instructions">
      Maquette must be calibrated before it will work. To calibrate a tower, position it
      fully upright on the maquette, and select 'Calibrate' from the drop down.
      </div> <!-- maquette calibration instructions -->
      <div class="flex-container" id="towerControlBlock">
        <div class="towerControl" id="mT1Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 1</span>
          <div>
          <select id="mT1Enable" class="tower-select">
            <option value="true">ENABLE</option>
            <option value="false">DISABLE</option>
          </select>
          </div>
          <div>
          <select id="mT1Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="mT1J1Enable" class="tower-select">
            <option value="true">J1 ENABLE</option>
            <option value="false">J1 DISABLE</option>
          </select>
          </div>
          <div>
          <select id="mT1J2Enable" class="tower-select">
            <option value="true">J2 ENABLE</option>
            <option value="false">J2 DISABLE</option>
          </select>
          </div>
          <div>
          <select id="mT1J3Enable" class="tower-select">
            <option value="true">J3 ENABLE</option>
            <option value="false">J3 DISABLE</option>
          </select>
          </div>
          </div>
        </div> <!-- mT1Control -->
        <div class="towerControl" id="mT2Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 2</span>
          <div>
          <select id="mT2Enable" class="tower-select">
            <option value="true">ENABLED</option>
            <option value="false">DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT2Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="mT2J1Enable" class="tower-select">
            <option value="true">J1 ENABLED</option>
            <option value="false">J1 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT2J2Enable" class="tower-select">
            <option value="true">J2 ENABLED</option>
            <option value="false">J2 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT2J3Enable" class="tower-select">
            <option value="true">J3 ENABLED</option>
            <option value="false">J3 DISABLED</option>
          </select>
          </div>
          </div>
        </div><!-- mT2Control -->
        <div class="towerControl" id="mT3Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 3</span>
          <div>
          <select id="mT3Enable" class="tower-select">
            <option value="true">ENABLED</option>
            <option value="false">DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT3Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="mT3J1Enable" class="tower-select">
            <option value="true">J1 ENABLED</option>
            <option value="false">J1 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT3J2Enable" class="tower-select">
            <option value="true">J2 ENABLED</option>
            <option value="false">J2 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT3J3Enable" class="tower-select">
            <option value="true">J3 ENABLED</option>
            <option value="false">J3 DISABLED</option>
          </select>
          </div>
          </div>
        </div> <!--mT3Control-->
        <div class="towerControl" id="mT4Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 4</span>
          <div>
          <select id="mT4Enable" class="tower-select">
            <option value="true">ENABLED</option>
            <option value="false">DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT4Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="mT4J1Enable" class="tower-select">
            <option value="true">J1 ENABLED</option>
            <option value="false">J1 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT4J2Enable" class="tower-select">
            <option value="true">J2 ENABLED</option>
            <option value="false">J2 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="mT4J3Enable" class="tower-select">
            <option value="true">J3 ENABLED</option>
            <option value="false">J3 DISABLED</option>
          </select>
          </div>
          </div>
        </div> <!-- mT4Control -->
      </div>
      </div>
   </div> <!-- maquette control -->
   <div id="maquettePosition" class="pane">
     <span class="subhead1">Maquette Position:</span><br>
     <div class="maquette-refresh-buttons">
       <button type="button" id="mStatusRefresh">Refresh</button>
       <button type="button" id="mStatusLive">Go Live</button> 
     </div>
     <div class="flex-container">
     <div id="mT1Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 1 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="mT1Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail"><span id="mT1J1Position"></span></div>
            <div class="tower-position-detail"><span id="mT1J2Position"></span></div>
            <div class="tower-position-detail"><span id="mT1J3Position"></span></div>
          </div>
          </div>
       </div>
     </div>
     <div id="mT2Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 2 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="mT2Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail"><span id="mT2J1Position"></span></div>
            <div class="tower-position-detail"><span id="mT2J2Position"></span></div>
            <div class="tower-position-detail"><span id="mT2J3Position"></span></div>
          </div>
          </div>
       </div>
     </div>
     <div id="mT3Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 3 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="mT3Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail"><span id="mT3J1Position"></span></div>
            <div class="tower-position-detail"><span id="mT3J2Position"></span></div>
            <div class="tower-position-detail"><span id="mT3J3Position"></span></div>
          </div>
          </div>
       </div>
     </div>
     <div id="mT4Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 4 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="mT4Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail"><span id="mT4J1Position"></span></div>
            <div class="tower-position-detail"><span id="mT4J2Position"></span></div>
            <div class="tower-position-detail"><span id="mT4J3Position"></span></div>
          </div>
          </div>
       </div>
     </div>
   </div> <!-- flex container -->
   </div> <!-- maquette position -->
  </div><!-- maquette div -->
  <div id="sculpture_div">
    <h3> Sculpture </h3>
    <div id="sculpture_control">
      <div id="sculpture_mode" class="pane sculpture-bg">
      <span class="subhead1">Sculpture Mode:<br></span>
      <select id="sculptureMode">
        <option value="false" selected="selected">OFF</option>
        <option value="true">RUN</option>
      </select>
      <span class="subhead1">Input Source:</span>
      <select id="sculptureInputSource">
        <option value="MAQUETTE">Maquette</option>
        <option value="MANUAL">Manual</option>
        <option value="RECORDING">Recording</option>
        <option value="PATTERN">Pattern</option>
      </select>
      </div> <!-- sculpture mode-->
      <div id="sculptureTowerControl" class="pane sculpture-bg"> 
      <span class="subhead1"> Sculpture Tower Control:<br> </span>
      <div class="calibration_instructions">
      Sculpture must be calibrated before each use. To calibrate a tower, position it
      upright on (set input source to 'Manual', and use the position sliders to move the tower), and select 'Calibrate' from the drop down.
      </div> <!-- sculpture calibration instructions -->
      <div class="flex-container" id="sculptureTowerControlBlock">
        <div class="towerControl" id="T1Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 1</span>
          <div>
          <select id="T1Enable" class="tower-select">
            <option value="true">ENABLED</option>
            <option value="false">DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T1Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="T1J1Enable" class="tower-select">
            <option value="true">J1 ENABLED</option>
            <option value="false">J1 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T1J2Enable" class="tower-select">
            <option value="true">J2 ENABLED</option>
            <option value="false">J2 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T1J3Enable" class="tower-select">
            <option value="true">J3 ENABLED</option>
            <option value="false">J3 DISABLED</option>
          </select>
          </div>
          </div>
        </div> <!-- T1Control -->
        <div class="towerControl" id="T2Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 2</span>
          <div>
          <select id="T2Enable" class="tower-select">
            <option value="true">ENABLED</option>
            <option value="false">DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T2Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="T2J1Enable" class="tower-select">
            <option value="true">J1 ENABLED</option>
            <option value="false">J1 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T2J2Enable" class="tower-select">
            <option value="true">J2 ENABLED</option>
            <option value="false">J2 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T2J3Enable" class="tower-select">
            <option value="true">J3 ENABLED</option>
            <option value="false">J3 DISABLED</option>
          </select>
          </div>
          </div>
        </div><!-- T2Control -->
        <div class="towerControl" id="T3Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 3</span>
          <div>
          <select id="T3Enable" class="tower-select">
            <option value="true">ENABLED</option>
            <option value="false">DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T3Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="T3J1Enable" class="tower-select">
            <option value="true">J1 ENABLED</option>
            <option value="false">J1 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T3J2Enable" class="tower-select">
            <option value="true">J2 ENABLED</option>
            <option value="false">J2 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T3J3Enable" class="tower-select">
            <option value="true">J3 ENABLED</option>
            <option value="false">J3 DISABLED</option>
          </select>
          </div>
          </div>
        </div> <!--T3Control-->
        <div class="towerControl" id="T4Control">
          <div class="tower-control-inner">
          <span class="towerhead">Tower 4</span>
          <div>
          <select id="T4Enable" class="tower-select">
            <option value="true">ENABLED</option>
            <option value="false">DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T4Center" class="tower-select">
            <option value="true">CALIBRATED</option>
            <option value="false">DECALIBRATED</option>
          </select>
          </div>
          <div>
          <select id="T4J1Enable" class="tower-select">
            <option value="true">J1 ENABLED</option>
            <option value="false">J1 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T4J2Enable" class="tower-select">
            <option value="true">J2 ENABLED</option>
            <option value="false">J2 DISABLED</option>
          </select>
          </div>
          <div>
          <select id="T4J3Enable" class="tower-select">
            <option value="true">J3 ENABLED</option>
            <option value="false">J3 DISABLED</option>
          </select>
          </div>
          </div>
        </div> <!-- T4Control -->
      </div>
      </div>
   </div> <!-- sculpture control -->
   <div id="sculpturePosition" class="pane sculpture-bg">
     <span class="subhead1">Sculpture Position:</span><br>
     <div class="maquette-refresh-buttons">
       <button type="button" id="statusRefresh">Refresh</button>
       <button type="button" id="statusLive">Go Live</button> 
     </div>
     <div class="flex-container">
     <div id="T1Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 1 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="T1Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail">
                <span id="T1J1Position">1.0</span>
                <input class="towerPositionSlider" id="T1J1PositionSlider" type="range" min="0" min=255/>
            </div>
            <div class="tower-position-detail">
                <span id="T1J2Position">1.0</span>
                <input class="towerPositionSlider" id="T1J2PositionSlider" type="range" min="0" min=255/>
            </div>
            <div class="tower-position-detail">
                <span id="T1J3Position">1.0</span>
                <input class="towerPositionSlider" id="T1J3PositionSlider" type="range" min="0" min=255/>
            </div>
          </div>
          </div>
       </div>
     </div>
     <div id="T2Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 2 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="T2Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail"><span id="T2J1Position"></span></div>
            <div class="tower-position-detail"><span id="T2J2Position"></span></div>
            <div class="tower-position-detail"><span id="T2J3Position"></span></div>
          </div>
          </div>
       </div>
     </div>
     <div id="T3Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 3 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="mT3Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail"><span id="T3J1Position"></span></div>
            <div class="tower-position-detail"><span id="T3J2Position"></span></div>
            <div class="tower-position-detail"><span id="T3J3Position"></span></div>
          </div>
          </div>
       </div>
     </div>
     <div id="T4Position" class="tower-display">
       <div class="tower-display-inner">
          <span class="towerhead">Tower 4 Position</span>
          <div>
          <div class="tower-canvas-pane">
            <canvas id="mT4Canvas" class="tower-canvas">
          </div>
          <div class="tower-position-pane">
            <div class="tower-position-detail"><span id="T4J1Position"></span></div>
            <div class="tower-position-detail"><span id="T4J2Position"></span></div>
            <div class="tower-position-detail"><span id="T4J3Position"></span></div>
          </div>
          </div>
       </div>
     </div>
   </div> <!-- flex container -->
   </div> <!-- sculpture position -->
</div><!-- maquette div -->
<!--
<div id="sculpture_div">
<h3> Sculpture Control</h3>
    <div id="control">
    <button type="button" id="enableT1">Enable T1</button><br>
    <button type="button" id="enableT2">Enable T2</button><br>
    <button type="button" id="enableT3">Enable T3</button><br>
    <button type="button" id="enableT4">Enable T4</button><br>
    <br>Return Status </br>
    <textarea id="feedbackText" style="width:400px; height:200px"></textarea>
    </div>
    Test Canvas
    <div>
    <canvas id="testCanvas" width="200" height="200" style="border:1px solid #000000"/>
    </div>
</div> --> <!-- sculpture div -->
</div> <!-- tabs -->
</body>
<script type="text/javascript" src="js/jquery-1.4.3.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-min-1.8.24.js"></script>
<script>
  $( function() {
    $( "#tabs" ).tabs();
  } );
</script>
<script type="text/javascript" >

var feedbackTextLineCount = 0;
var MAX_FEEDBACK_LINES = 40;

function makeTower() {
    var tower = {};
    tower.running = "N/A";
    tower.error = "N/A";
    tower.joints = [];
    for (var i=0; i<3; i++) {
        var joint = {};
        joint.pos = 0;
        joint.target = 0;
        joint.drive = 0;
        joint.min = 0;
        joint.max = 0;
        joint.center = 0;
        joint.homed = "N/A";
        joint.p = 0;
        joint.i = 0;
        joint.enabled = false;
        tower.joints[i] = joint;
    }
    return tower;
}

function displayError(text) {
    displayText(text, "ERROR: ");
}

function displaySuccess(text) {
    displayText(text, "SUCCESS: ");
}

function displayText(text, prolog) {
    var currentText = $("#feedbackText").text();
    var prologText = "";
    if (prolog != null) {
        prologText = prolog;
    }
    currentText = currentText + "\n" + prologText + text;
    feedbackTextLineCount++;
    if (feedbackTextLineCount> MAX_FEEDBACK_LINES) {
        var idx = currentText.indexOf('\n');
        currentText = currentText[idx+1];
        feedbackTextLineCount--;
    }
    console.log(currentText);
    $("#feedbackText").text(currentText);
}

// XXX - Note that I'm assuming certain limits. Not sure
// whether these are the limits that I should assume
// Whatever the limits are, they probably shouldn't be set at this
// level of the code. FIXME?
function calibrateSculptureTower(towerId, calibrate_tf) {
    var tf_cal = calibrate_tf == "true";
    setTowerCenter(towerId, tf_cal, function(tf) {
        console.log("Set tower center returns " + tf);
        if (!tf || !tf_cal) return; 
        setTowerLimits(towerId, -250, -250, -250, 300, 300, 300, function(tf) {
           console.log("Set tower limits returns " + tf);  
           if (!tf) return; 
           /* setTowerLimits(towerId, 2, -250, 300, function(tf) {
                if (!tf) return;
                setTowerLimits(towerId, 3, -250, 300,  function(tf) {
                    if (!tf) return;
                    setRunning(towerId, function(tf) {
                        if (!tf) return;
                    });
                });
            }); */
        });
    });
}    


// nb - towerid (or joint id) is 1 based
// towerIdx (or joint idx) is 0 based

var CROWN_SCULPTURE_BASE = "/crown/sculpture";
var CROWN_MAQUETTE_BASE = "/crown/maquette";

function getMaquetteStatus() {
    $.ajax({
        type: 'GET',
        dataType: 'json',
        url: CROWN_MAQUETTE_BASE  + "/maquette/towers/",
        success: function(data, status, req) {
            $("#maquette_status").text(data);  // XXX I shouldn't have to cal parse json, but for the moment
            },
        error: function(data, status, req) {
            console.log("Error getting maquette status")
        }
    });
}

function towerResponseToTower(towerJson, towerIdx)
{
    var tower = gTowers[towerIdx]
    tower.running = towerJson.running;
    tower.error   = towerJson.error;
    for (var i=0; i<3; i++) {
        tower.joints[i].pos = towerJson.joints[i].pos;
        tower.joints[i].min = towerJson.joints[i].min;
        tower.joints[i].max = towerJson.joints[i].max;
        tower.joints[i].center = towerJson.joints[i].center;
        tower.joints[i].homed  = towerJson.joints[i].homed;
        tower.joints[i].enabled = towerJson.joints[i].enabled;
    }
}

function setTowerCenter(towerId, calibrate_tf, callbackfn=null) {
    console.log("set tower " + towerId + " center");
    $.ajax({
        type: 'PUT',
        url: CROWN_SCULPTURE_BASE  + "/towers/" + (towerId) + "/center",
        data: {'calibrate': calibrate_tf},  // XXX - not set up to handle in sculpture yet; make parallel to maquette
        success: function(data, status, req) {
            //checkTowerCenter(towerId); // I don't know how to check the tower center, so punting here
            if (callbackfn != null) {
                callbackfn(true);
            }
            },
        error: function(data, status, req) {
            displayError("Internal error " + status + " setting tower " + towerId + " center");
            console.log("Error requesting data\n");
            if (callbackfn != null) {
                callbackfn(false);
            }
        }
    });
}

function setTowerLimits(towerId, j1_min, j2_min, j3_min, j1_max, j2_max, j3_max, callbackfn) {
    console.log("set tower " + towerId + " limits");
    $.ajax({
        type: 'PUT',
        url: CROWN_SCULPTURE_BASE  + "/towers/" + (towerId) + "/limits",
        data: {'j1_min': j1_min,
               'j2_min': j2_min,
               'j3_min': j3_min,
               'j1_max': j1_max,
               'j2_max': j2_max,
               'j3_max': j3_max},
        success: function(data, status, req) {
            //checkTowerLimits(towerId, jointId, min, max, callbackfn);
        },
        error: function(data, status, req) {
            displayError("Internal error " + status + " setting tower " + towerId + " limits");
            console.log("Error setting tower limits\n");
            callbackfn(false);
        }
    });
}

// XXX - for the moment, I'm not doing this. The idea is to make very very sure that the limits
// have been set correctly. XXX FIXME
function checkTowerLimits(towerId, jointId, min, max, callbackfn) {
    var checkLimitsTimeout = 0;
    console.log("check tower limits " + towerId + ", joint " + jointId);
    checkLimitsTimeout = setTimeout(function() {
        displayError("Could not verify limits  on tower " + towerId + ", joint " + jointId);
        callbackfn(false);
    }, 500);
    $.ajax({
        type: 'GET',
        url: CROWN_SCULPTURE_BASE + "/towers/" + (towerId) + "/joints/" + jointId + "/limits",

        success: function(data, status, req) {
            clearTimeout(checkLimitsTimeout);
            var jointIdx = jointId - 1;
            if (data[0]["min"] == min && data[0]["max"] == max) {
                displaySuccess("Set limits on tower " + towerId + ", joint " + jointId + ", min: " + min + " max: " + max);
                callbackfn(true);
            } else {
                displayError("Limits on tower " +  towerId + ", joint " + jointId + " not set correctly");
                callbackfn(false);
            }
        },
        error: function(data, status, req) {
            console.log("Internal error " + status + " checking tower " + towerId + ", joint "  +  jointId + " limits");
            // let the timeout handle displaying any errors
        }
    });
}

// force all joints to homed and set them running
function setRunning(towerId, callbackfn) {
    console.log("setting tower running");
    $.ajax({
        type: 'POST',
        url: CROWN_SCULPTURE_BASE + "/towers/" + (towerId) + "/running",
        data: {"running":true,
               "homed": true 
              },
        success: function(data, status, req) {
            checkRunning(towerId, callbackfn) 
        },
        error: function(data, status, req) {
            console.log("Internal error " + status + " setting " + towerId + " running");
            callbackfn(false);
        }
    });    
}

function checkRunning(towerId, callbackfn) {
    var checkRunningTimeout = 0;
    checkRunningTimeout = setTimeout(function() {
        displayError("Could not verify run status on tower " + towerId);
        callbackfn(false);  
    }, 500);
    $.ajax({
        type: 'GET',
        url: CROWN_SCULPTURE_BASE + "/towers/" + (towerId),
        data: {"running":true,
               "homed": true 
              },
        success: function(data, status, req) {
            clearTimeout(checkRunningTimeout);
            if (data[towerId]["running"] != true 
               || (data["enabled"][0] && !data["homed"][0])
               || (data["enabled"][1] && !data["homed"][1])
               || (data["enabled"][2] && !data["homed"][2])) { 
               displayError("Trouble setting tower " + towerId + " running. Run state is " 
                + data["running"] + ", homed state is " + data["homed"] + ", enabled state is " 
                + data["enabled"]);
                callbackfn(false);
            } else {
                displaySuccess("Tower " + towerId + " ready");
                callbackfn(true);
            }
        },
        error: function(data, status, req) {
            console.log("Internal error " + status + " setting " + towerId + " running");
            // don't bother clearing the timeout - it will display a useful error soon if it hasn't 
            // already.
        }
    });    
}

function clearError(towerId, callbackfn) {
    $.ajax({
        type: 'POST',
        url: CROWN_SCULPTURE_BASE + "/towers/" + (towerId) + "/clearError",
        success: function(data, status, req) {
            checkError(towerId, callbackfn);
            },
        error: function(data, status, req) {
            console.log("Internal error " + status + " clearing " + towerId + " error");
            callbackfn(false);
        }
    });       
}

function checkError(towerId, callbackfn) {
    var checkErrorTimeout = 0;
    checkErrorTimeout = setTimeout(function() {
        displayError("Could not verify run status on tower " + towerId);   
        callbackfn(false); 
    }, 500);
    $.ajax({
        type: 'GET',
        url: CROWN_SCULPTURE_BASE + "/towers/" + (towerId),
        success: function(data, status, req) {
            clearTimeout(checkErrorTimeout);
            if (data["error"] != 0) {
                displayError("Error on tower " + towerId + " persists, currently " + data["error"]);
                callbackfn(false);
            }
            callbackfn(true);
        },
        error: function(data, status, req) {
            console.log("Internal error " + status + " checking " + towerId + " error");
            // let timeout handle error display
        }
    });       
}

function getTowerByIdx(towerIdx){
    console.log("Get tower by Idx!!\n");
    if (towerIdx < 0 || towerIdx > 3) {
        console.log("Bad input to get tower");
        return;
    }
    
    $.ajax({
        type: 'GET',
        url: CROWN_SCULPTURE_BASE  + "/towers/" + (towerIdx + 1),
        success: function(data, status, req) {
            towerResponseToTower(data[towerIdx+1], towerIdx);
            renderTowerInfo(towerIdx)
            /*
            console.log(data);
            $("#controller_x").html(data["control_x"]);
            $("#controller_y").html(data["control_y"]);
            $("#controller_z").html(data["control_z"]);

            $("#sculpture_x").html(data["sculpture_x"]);
            $("#sculpture_y").html(data["sculpture_y"]);
            $("#sculpture_z").html(data["sculpture_z"]);

            $("#manual_x").val(data["manual_x"]);
            $("#manual_y").val(data["manual_y"]);
            $("#manual_z").val(data["manual_z"]);*/
            },
        error: function(data, status, req) {
            console.log("Error requesting data\n");
        }
    });
    /*
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4) {  // transaction complete
            if (xmlHttp.status == 200) {
                console.log("success receiving information about tower " + (towerIdx+1));
                var towerJson = JSON.parse(xmlHttp.responseText);
                towerResponseToTower(towerJson, towerIdx);
                renderTowerInfo(towerIdx)
            } else {
                console.log("Call to get info for tower " + towerIdx + "fails, error " + xmlHttp.status + " errorText " + xmlHttp.responseText);
            }
        } else {
            console.log("ready state change\n");
        }
    }  
    */  
    console.log("Attempting to get tower!");
//    xmlHttp.open("GET", CROWN_SCULPTURE_BASE  + "/towers/" + towerIdx, true); // true for asynchronous
//    xmlHttp.open("GET", "localhost:5050"  + "/towers/" + towerIdx, true); // true for asynchronous
}

function requestMaquetteStatus(){
    $.ajax({
       type: 'GET',
       url: CROWN_MAQUETTE_BASE,
       dataType: 'json',
       success: function(data, status, req) {
          renderMaquetteStatus($.parseJSON(data));
          },
       error: function(data, status,req) {
          console.log("Error getting maquette status");
          }
     });
}


function requestSculptureStatus() {
    $.ajax({
        type: 'GET',
        url: CROWN_SCULPTURE_BASE,
        dataType: 'json',
        success: function(data, status, req) {
            renderSculptureStatus($.parseJSON(data));
            },
        error: function(data, status, req) {
            console.log("Error getting sculpture status");
            }
    });
}

function enableMaquetteTower(towerId, enabletf){
    $.ajax({
        type: 'PUT',
        url: CROWN_MAQUETTE_BASE + "/towers/" + (towerId),
        data: {"enable" : enabletf.toString()},
        success: function(data, status, req) {
            console.log("Changed tower " + towerId + " enable state to "  + enabletf);
            },
        error: function(data, status, req) {
            console.log("Fail to change tower enable state");
            $('#mT' + towerId + 'Enable').val(!enabletf);
        }
    });
}
    
function enableMaquetteJoint(towerId, jointId, enabletf){
    $.ajax({
        type: 'PUT',
        url: CROWN_MAQUETTE_BASE + "/towers/" + (towerId) + "/joints/" + jointId,
        data: {"enable" : enabletf.toString()},
        success: function(data, status, req) {
            console.log("Changed joint MT" + towerId + "J" + jointId + " enable state to "  + enabletf);
            },
        error: function(data, status, req) {
            console.log("Fail to change joint enable state");
            $('#mT' + towerId + "J" + jointId + 'Enable').val(!enabletf);
        }
    });
}
    
    

gTowers = [];
gRefreshStatusInterval = -1;
maquetteMode = "off";

function initData() {
    requestMaquetteStatus();
    // requestSculptureStatus();  // XXX - not doing this just yet. FIXME write code for it anyway
}

function setColorOnSelect(elem) {
    var onClass;
    var offClass;
    if (elem.val() == undefined) {
        console.log("Undefined value, elem is " + elem) ;
    }
    if (elem.val() == "true") {
        onClass = "goodtogo";
        offClass = "notgoodtogo";
    } else {
        onClass = "notgoodtogo";
        offClass = "goodtogo";
    }
    elem.removeClass(offClass);
    elem.addClass(onClass);
}

function setOptionText(id, texts)
{
    if (!id.startsWith("#")) id = "#" + id; 
    let optionTrue = $(id + " option[value='true']");
    let optionFalse = $(id + " option[value='false']");
    optionTrue.text(texts[0]);
    optionFalse.text(texts[1]);
}

function initControls() {
    console.log("init called");
    $('#mStatusRefresh').click(function() {
        requestMaquetteStatus();
    });
 
    $('#mStatusLive').click(function() {
        // What happens here depends on whether we are
        // currently live...
        if ($('#mStatusLive').text() == 'Go Live') {
            // XXX dependent on value from above, this is trouble
            if (gRefreshStatusInterval >= 0) {
                clearInterval(gRefreshStatusInterval);
            }
            gRefreshStatusInterval = setInterval(requestMaquetteStatus, 500);
            $('#mStatusLive').text('Stop Live');
        } else {
            clearInterval(gRefreshStatusInterval);
            gRefreshStatusInterval = -1;
            $('#mStatusLive').text('Go Live');
        }
    });

    // Set up maquette tower and joint enable/disable
    for (var tIdx=0; tIdx<4; tIdx++) {
        let towerIdx = tIdx + 1;  // Tower idx in API is one-based. 
        let enableTowerId = '#mT' + towerIdx + 'Enable';
        $(enableTowerId).change(function(){
            const id = '#mT' + towerIdx + 'Enable';
            const tf = $(id).find(":selected").val();
            setOptionText(id, tf=="true"?["ENABLED", "DISABLE"]:["ENABLE", "DISABLED"]);
            setColorOnSelect($(this));
            enableMaquetteTower(towerIdx, $(this).val());
        });

        var centerTowerId = '#mT' + towerIdx + 'Center';
        $(centerTowerId).change(function(){
            setOptionText(this.id, this.value=="true"?["CALIBRATED", "DECALIBRATE"]:["CALIBRATE", "DECALIBRATED"]);
            setColorOnSelect($(this));
            calibrateMaquetteTower(towerIdx, $(this).val());
        });
        for (var jIdx=0; jIdx<3; jIdx++) {
            let jointIdx = jIdx + 1;  // As above, joint idx in API is one-based
            let enableJointId = '#mT' + towerIdx + 'J' + jointIdx + 'Enable';
            $(enableJointId).change(function() {
                // const id = $('#mT' + towerIdx + 'J' + jointIdx + 'Enable');
                // const tf = $(id).find(":selected").val();
                setOptionText(this.id, this.value=="true"? ["J" + jointIdx + " ENABLED", "J" + jointIdx + " DISABLE"] : ["J" + jointIdx + " ENABLE", "J" + jointIdx + " DISABLED"]) 
                setColorOnSelect($(this));
                enableMaquetteJoint(towerIdx, jointIdx, $(this).val());
            });
        }
    };
    
    // Set up maquette mode change functionality
    $("#maquetteMode").change(function(){
        console.log("Changed maquette mode");
        var stateValue = $("#maquetteMode option:selected").val();
        console.log("Selected value is " + stateValue);
        $.ajax({
            type: 'PUT',
            url: CROWN_MAQUETTE_BASE,
            data: {"mode" : stateValue},
            success: function(data, status, req) {
                console.log("Changed maquette state to " + stateValue);
                maquetteMode = stateValue;
                },
            error: function(data, status, req) {
                $("#maquetteMode").val(maquetteMode);
            }
        });
    });

    // Set up sculpture tower and joint enable/disable/calibrate
    for (var tIdx=0; tIdx<4; tIdx++) {
        let towerIdx = tIdx + 1;  // Tower idx in API is one-based. 
        let enableTowerId = '#T' + towerIdx + 'Enable';
        $(enableTowerId).change(function(){
            const id = '#T' + towerIdx + 'Enable';
            const tf = $(id).find(":selected").val();
            setOptionText(id, this.value=="true" ? ["ENABLED", "DISABLE"] : ["ENABLE", "DISABLE"]);
            setColorOnSelect($(this));
            enableSculptureTower(towerIdx, $(this).val());
        });

        var centerTowerId = '#T' + towerIdx + 'Center';
        $(centerTowerId).change(function(){
            setColorOnSelect($(this));
            calibrateSculptureTower(towerIdx, $(this).val());
        });
        for (var jIdx=0; jIdx<3; jIdx++) {
            let jointIdx = jIdx + 1;  // As above, joint idx in API is one-based
            let enableJointId = '#T' + towerIdx + 'J' + jointIdx + 'Enable';
            $(enableJointId).change(function() {
                const id = $('#T' + towerIdx + 'J' + jointIdx + 'Enable');
                // const tf = $(id).find(":selected").val();
                setOptionText(id, this.value=="true"? ["J" + towerIdx + " ENABLED", "J" + towerIdx + " DISABLE"] : ["J" + towerIdx + " ENABLE", "J" + towerIdx + " DISABLED"]);
                setColorOnSelect($(this));
                enableSculptureJoint(towerIdx, jointIdx, $(this).val());
            });
            let sliderPositionJointId = "#T" + towerIdx + 'J' + jointIdx + 'PositionSlider';
            $(sliderPositionJointId).change(function() {
                let val = this.value;
                val = (val/50) - 1;  // 0-100 is normal range, changing to -1 to 1
                if (val < -1.0) val = -1.0;
                if (val > 1.0) val = 1.0;
                setTowerCanonicalJointPosition(towerIdx, jointIdx, val);
            });
            // Initially, let's turn all these things off
            $(sliderPositionJointId).disabled = true;
        }
    };

    // Set up sculpture mode change
    $("#sculptureInputSource").change(function() {
        console.log("Change sculpture input source");
        let curValue = this.value;
        if (curValue == "MANUAL") {
            // enable sliders, disable maquette
            enableTowerPositionSliders(true);
            enableMaquette(false);
        } else if (curValue == "MAQUETTE") {
            // disable sliders, enable maquette
            enableTowerPositionSliders(false);
            enableMaquette(true); 
        } else if (curValue == "PATTERN" || curValue == "RECORDING") {
            // disable sliders, disable maquette, show choose pattern dialog
            enableTowerPositionSliders(false);
            enableMaquette(true);
        }
    });
}

 
function setTowerCanonicalJointPosition(towerIdx, jointIdx, val)
{
    if (val < -1.0) val = -1.0;
    if (val > 1.0) val = 1.0;

    $.ajax({
        type: 'PUT',
        url: CROWN_SCULPTURE_BASE  + "/towers/" + towerIdx + "/joints/" + jointIdx + "/position",
        data: {"pos": val},
        success: function(data, status, req) {
        },
        error: function(data, status, req) {
            displayError("Problem setting tower joint position");
        }
    });
}

 
function enableMaquette(tf) 
{
    let maquetteMode = $("#maquetteMode");
    if (tf) {
        maquetteMode.removeAttr("disabled");
    } else {
        // set maquette mode to off, and grey out control
        maquetteMode.val("OFF");
        maquetteMode.attr("disabled", "disabled");
    }
}


function enableTowerPositionSliders(tf) {
    if (tf) {
        $(".towerPositionSlider").removeAttr('disabled');
    } else {
        $(".towerPositionSlider").attr('disabled', 'disabled');
    }
}

function getMaquetteCalibrationStatus() {
    $.ajax({
        type: 'GET',
        url: CROWN_MAQUETTE_BASE  + "/calibration",
        success: function(data, status, req) {
            if ((data[0] == 1) && (data[1] == 1) && (data[2] == 1) && (data[3] == 1)){
                displayText("Maquette Calibrated", "STATUS: ");
                console.log("Centered maquette tower " + towerId);
            } else {
                if (data[0] != 1) {
                    displayText("Tower 1 not calibrated", "STATUS: ", );
                }
                if (data[1] != 1) {
                    displayText("Tower 2 not calibrated", "STATUS: ", );
                }
                if (data[2] != 1) {
                    displayText("Tower 3 not calibrated", "STATUS: ", );
                }
                if (data[3] != 1) {
                    displayText("Tower 4 not calibrated", "STATUS: ", );
                }
            }
        },
        error: function(data, status, req) {
            displayError("Problem getting maquette calibration status");
        }
    });
}

function calibrateMaquetteTower(towerId, tf) {
    var calibrate_tf = {};
    // XXX - isn't tf always a string, so this is always true?
    if (tf === "true") {
        console.log("Calibrating tower");
        calibrate_tf['calibrate'] = true;
    } else {
        calibrate_tf['decalibrate'] = true;
        console.log("Decalibrating tower");
    }
        
    $.ajax({
        type: 'PUT',
        url: CROWN_MAQUETTE_BASE  + "/towers/" + towerId,
        data: calibrate_tf,
        success: function(data, status, req) {
            console.log("Centered maquette tower " + towerId);
            },
        error: function(data, status, req) {
            $("#mT" + towerId + "Enable").val(!tf);
            console.log("Error enabling maquette tower " + towerId);
        }
    });
}


function renderMaquetteStatus(status){
    // Set mode
    $('#maquetteMode').val(status["mode"]);
    // Set tower information
    for (var idx=0; idx<4; idx++) {
        var tower = status["towerState"][idx];
        // $("#mT" + (idx+1) + "Position").text(tower["jointPos"].toString());
        // enable/disable
        let towerEnableElem = $("#mT" + (idx+1) + "Enable");
        towerEnableElem.val(tower["towerEnabled"].toString());
        let optionEnabled = $("#mT" + (idx+1) + "Enable" + " option[value='true']");
        let optionDisabled = $("#mT" + (idx+1) + "Enable" + " option[value='false']");
        if (tower["towerEnabled"] == true) {
            optionDisabled.text('DISABLE');
            optionEnabled.text('ENABLED');
        } else {
            optionEnabled.text('ENABLE');
            optionDisabled.text('DISABLED');
        }
        setColorOnSelect(towerEnableElem);
        // calibrated
        console.log("tower center " + idx);
        let towerCenterElem = $("#mT" + (idx+1) + "Center");
        towerCenterElem.select(tower["calibrated"]);
        setColorOnSelect(towerCenterElem);
        // joint enabled/disable
        for (var jIdx=0; jIdx<3; jIdx++) {
            let jointEnableElem = $("#mT" + (idx+1) + "J" + (jIdx+1) + "Enable");
            jointEnableElem.val(tower["jointEnabled"][jIdx].toString());
            setColorOnSelect(jointEnableElem);
            let jointPosElem = $("#mT" + (idx+1) + "J" + (jIdx+1) + "Position");
            jointPosElem.text(Number(tower["jointPos"][jIdx]).toFixed(2));
        }
        // render the tower
        let jointAngle0 = tower["jointPos"][0]*Math.PI/9;
        let jointAngle1 = tower["jointPos"][1]*Math.PI/9;
        let jointAngle2 = tower["jointPos"][2]*Math.PI/9;
        let canvas = document.getElementById("mT" + (idx+1) + "Canvas");
        drawTower(canvas, jointAngle0, jointAngle1, jointAngle2);
    } 
}

// XXX - add sw and hardware disable. I think this is at the joint level? It's in the jcb...
// But I also think that it's only at the tower level? figure this out... FIXME
function renderSculptureStatus()
{
    // Should be able to get all of this from a single call.
    // XXX - make sure this is working
}

function renderTowerInfo(tIdx) {
    var tower = gTowers[tIdx];
    // XXX - sculpture mode is a whole sculpture value, but all of the towers are independent.
    // what to do here?
    // $("#T" + (idx+1) + "SculptureMode").val(tower.running);  // Check values - have I changed SculptureMode?
    // $("#t" + idx + "Status[name=error]").text(tower.error);
    let towerCentered = true;
    for (let jIdx=0; jIdx<3; jIx++) {
        let joint = tower.joints[jIdx];
        let jointEnableElem = $("#T" + (tIdx+1) + "J" + (jIdx+1) + "Enable");
        jointEnableItem.val(joint.enabled);
        setColorOnSelect(jointEnableElem);
        let jointPosElem = $("#T" + (tIdx+1) + "J" + (jIdx+1) + "Position");  // XXX - this is a slider here
        jointPosElem.val(joint.pos); 
        towerCentered = towerCentered && joint.homed;
    }
    let towerCenterElem = $("#T" + (tIdx+1) + "Center");
    towerCenterElem.select(towerCentered);
    setColorOnSelect(towerCenterElem);
    let towerEnabledElem = $("#T" + (tIdx+1) + "Enable");
    towerElem.select(tower.running);
    setColorOnSelect(towerElem);

    // render tower position // XXX - I need canonical values here...
    let jointAngle0 = tower.joints[0] * Math.PI/9; // XXX what are the values, really?
    let jointAngle1 = tower.joints[1] * Math.PI/9; // XXX what are the values, really?
    let jointAngle2 = tower.joints[2] * Math.PI/9; // XXX what are the values, really?
    let canvas = document.getElementById("T" + (tIdx+1) + "Canvas");
    drawTower(canvas, jointAngle0, jointAngle1, jointAngle2);  
    
    /*
    var jointEnabledText = "[" + tower.joints[0].enabled + "," + tower.joints[1].enabled + "," + tower.joints[2].enabled + "]";
    $("#t" + idx + "Status[name=joint_enabled]").text(jointEnabledText);
    var homingStatusText =  "[" + tower.joints[0].homed + "," + tower.joints[1].homed + "," + tower.joints[2].homed + "]";
    $("#t" + idx + "Status[name=homing_status]").text(homingStatusText);
    var curPosText = "[" + tower.joints[0].pos + "," + tower.joints[1].pos + "," + tower.joints[2].pos + "]";
    $("#t" + idx + "Status[name=current_position]").text(homingStatusText);
    $("#t" + idx + "Status[name=j1min]").text(tower.joints[0].min);
    $("#t" + idx + "Status[name=j1max]").text(tower.joints[0].max);
    $("#t" + idx + "Status[name=j1center]").text(tower.joints[0].center);

    $("#t" + idx + "Status[name=j2min]").text(tower.joints[1].min);
    $("#t" + idx + "Status[name=j2max]").text(tower.joints[1].max);
    $("#t" + idx + "Status[name=j2center]").text(tower.joints[1].center);

    $("#t" + idx + "Status[name=j3min]").text(tower.joints[2].min);
    $("#t" + idx + "Status[name=j3max]").text(tower.joints[2].max);
    $("#t" + idx + "Status[name=j3center]").text(tower.joints[2].center);
    */
}
// onselect - send to change mode
// XXX - target position would be nice to know as well. I'm not sure I pull that out anywhere

function homeTower(towerIdx, jointIdx) {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4) {  // transaction complete
            if (xmlHttp.status == 200 || xmlHttpStatus == 202) {
                console.log("success requesting home of joint " + jointIdx + " on tower " + towerIdx);
                listenForHomingStatus(towerIdx, jointIdx);
            } else {
                console.log("Call to home joint " + jointId + " on tower" + towerId + "fails, error " + xmlHttp.status + " errorText " + xmlHttp.responseText);
            }
        }
    }    
    xmlHttp.open("POST", CROWN_SCULPTURE_BASE  + "/towers/" + (towerIdx+1) 
                                               + "/joints/" + (jointIdx+1) 
                                               + "/home", true); // true for asynchronous
    // POST /crown/sculpture/towers/[tid]/joints/[jid]/home
}

function listenForHomingStatus(towerIdx, jointIdx)
{
    // ping twice a second until we get a finished status
    var homingTimer = setInterval(function(){
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() {
            if (xmlHttp.readyState == 4) {  // transaction complete
                if (xmlHttp.status == 200) {
                    console.log("success getting homing status of joint " + jointIdx + " on tower " + towerIdx);
                    var homingStatus = JSON.parse(xmlHttp.responseText);
                    if (homingStatus.status == "DONE") { // XXX is this right?
                        clearInterval(homingTimer);
                    }
                    showHomingStatus(homingStatus);
                } else {
                    console.log("Call to home joint " + jointId + " on tower" + towerId + "fails, error " + xmlHttp.status + " errorText " + xmlHttp.responseText);
                }
            }
        }
    },500);
     
    xmlHttp.open("POST", CROWN_SCULPTURE_BASE  + "/towers/" + (towerIdx+1) 
                                               + "/joints/" + (jointIdx+1), 
                                               true); 
}

function showHomingStatus(homingStatus) {
}


function getHomingStatus(tid, jid) {
    // GET /crown/sculpture/tower/[id]/joints/[id]/homingStatus
}

function enableSculptureTower(towerId, tf) {
    // PUT /crown/sculpture/tower/[towerId]/running
    $.ajax({
        type: 'PUT',
        url: CROWN_SCULPTURE_BASE  + "/towers/" + towerId + "/running",
        data: {'run_state': tf},
        success: function(data, status, req) {
            console.log("Enabled sculpture tower " + towerId);
            },
        error: function(data, status, req) {
            $("#mT" + towerId + "Enable").val(!tf);  // XXX - check if this is a string or a boolean
            console.log("Error enabling sculpture tower " + towerId);
        }
    });
}

function enableSculptureJoint(towerId, jointId, enabletf){
    $.ajax({
        type: 'PUT',
        url: CROWN_SCULPTURE_BASE + "/towers/" + (towerId) + "/joints/" + jointId,
        data: {"enable" : enabletf.toString()},
        success: function(data, status, req) {
            console.log("Changed joint T" + towerId + "J" + jointId + " enable state to "  + enabletf);
            },
        error: function(data, status, req) {
            console.log("Fail to change joint enable state");
            // XXX - make sure enabletf is actually a boolean
            $('#T' + towerId + "J" + jointId + 'Enable').val(!enabletf);
        }
    });
}
    

function setHomeState(tid, tf) {
    // PUT /crown/sculpture/tower/[tid]/homed
}

function setPosition(tid, j1, j2, j3) {
    // PUT /crown/sculpture/tower/[tid]/position
}


const SEGMENT_LENGTH_LOWER=50;
const SEGMENT_LENGTH_MIDDLE=40;
const SEGMENT_LENGTH_UPPER=40;
function drawTower(canvas, theta1, theta2, theta3)
{
    const r1 = SEGMENT_LENGTH_LOWER;
    const r2 = SEGMENT_LENGTH_MIDDLE;
    const r3 = SEGMENT_LENGTH_UPPER;
    const startPoint = [canvas.width/2, canvas.height];
    var ctx = canvas.getContext("2d");
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.setTransform();
    ctx.translate(startPoint[0], startPoint[1]);
    ctx.rotate(theta1);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(0, -r1);
    ctx.translate(0, -r1);
    ctx.rotate(theta2);
    ctx.lineTo(0, -r2);
    ctx.translate(0, -r2);
    ctx.rotate(theta2);
    ctx.lineTo(0,-r3);
    ctx.stroke();
}

function doTests() {
// sandbox for playing with canvas, at the moment...
    var mycanvas = document.getElementById("testCanvas");
    // mycanvas.setTransform(); // zero the transform
    var theta1 = Math.PI/18;
    var theta2 = Math.PI/9;
    var theta3 = Math.PI/6;
    var r1 = 50;
    var r2 = 40;
    var r3 = 40;
    var startPoint = [100, 200];
    var ctx = mycanvas.getContext("2d");
    ctx.setTransform();
    ctx.translate(startPoint[0], startPoint[1]);
    ctx.rotate(theta1);
    ctx.moveTo(0,0);
    ctx.lineTo(0, -r1);
    ctx.translate(0, -r1);
    ctx.rotate(theta2);
    ctx.lineTo(0, -r2);
    ctx.translate(0, -r2);
    ctx.rotate(theta2);
    ctx.lineTo(0,-r3);
    ctx.stroke();
}

$(document).ready(function() {
    initControls();
    initData();
});

/*
    <div id="t1Status">
        Status: <span id="status1"></span><br>
        Error: <span id="error"></span><br>
        Running: <span id="running1"></span><br>
        Joint Enable: <span id="joint_enabled1"></span><br>
        Homing Status: <span id="homing_status1"></span><br>
        Current Position: <span name="current_position"></span><br>
        PID Values: <span name="PID_values"></span><br>
        Limits: <span name="limits"></span><br>
        <input type="button" value="Update Tower Status"><br>   
    </div>
    <div id="t1Control">
        Home Joints:<br>
        <input type="button" value="Home J1">
        <input type="button" value="Home J2">
        <input type="button" value="Home J3"><br>
        Set Position:<br>
        J1: <input type="text">  
        J2: <input type="text">
        J3: <input type="text"><br>
        <input type="button" value="Set Position"><br>
        Neuter:<br>
        <input type="button" value="Neuter J1">
        <input type="button" value="Neuter J2">
        <input type="button" value="Neuter J3"><br>
        Set Limits: <br>
        J1:  min: <input type="text">, max: <input type="text">, center: <input type="text"> <input type="button" value="Set J1 Limits"><br>
        J2:  min: <input type="text">, max: <input type="text">, center: <input type="text"> <input type="button" value="Set J1 Limits"><br>
        J3:  min: <input type="text">, max: <input type="text">, center: <input type="text"> <input type="button" value="Set J1 Limits"><br>
    </div>
*/
/* 
    Current Issues:
    -- Want to be able to issue a global sculpture state command, have results aggregated at arduino level
    -- Need to add sliders to sculpture tower position
    -- Need to have driver return both absolute and canonical positions
    -- Need a way to enable/disable a joint
    -- Need a way to uncalibrate a tower
    -- Need a way to set global running/not running state (?will this happen at arduino level? I don't think it can... Could find a way to switch out
    --   who is talking over the RS485 line. I sort of remember having something like that. (There are midi switches with physical buttons. If I want to switch electronically, I have to make my own)
    -- enable/disable slider based on selected mode (must be 'manual')
    -- general grey for disabled/unavailable elements
    -- General technical debt/code cleanup needs
*/
</script>
</html>
